<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Alumnos - Boy Happy</title>
<link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- STYLES -->
<!-- Lambda inyecta CSS inline aquí -->

<!-- SCRIPT -->
<!-- Lambda inyecta JS inline aquí -->

<!-- Alpine.js al FINAL con defer -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data>
<aside class="sidebar">
  <div class="sidebar-logo">
    <i class="fas fa-graduation-cap"></i>
    <span>Boy Happy</span>
  </div>
  <ul class="sidebar-menu">
    <li><a href="#" @click.prevent="$store.ui.navigateTo('anuncios')" :class="{ 'active': $store.ui.isActive('anuncios') }"><i class="fas fa-bullhorn"></i> Anuncios</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('calendario')" :class="{ 'active': $store.ui.isActive('calendario') }"><i class="fas fa-calendar"></i> Calendario</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('notas')" :class="{ 'active': $store.ui.isActive('notas') }"><i class="fas fa-file-alt"></i> Evaluaciones</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('asistencia')" :class="{ 'active': $store.ui.isActive('asistencia') }"><i class="fas fa-calendar-check"></i> Asistencia</a></li>
  </ul>
  <button class="logout-btn" @click="cerrarSesion()">
    <i class="fas fa-sign-out-alt"></i>
    <span>Cerrar Sesión</span>
  </button>
</aside>

<main class="main-content">
  <!-- Anuncios Section -->
  <div id="anuncios" class="section" x-data="anunciosAlumnoApp()" :class="{ 'active': $store.ui.isActive('anuncios') }">
    <div class="content-header">
      <h1><i class="fas fa-bullhorn"></i> Anuncios</h1>
    </div>

    <!-- Loading State -->
    <template x-if="anuncios.loading">
      <div class="card" style="text-align: center; padding: 40px; color: #667eea;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p style="margin-top: 15px;">Cargando anuncios...</p>
      </div>
    </template>

    <!-- Lista de Anuncios -->
    <template x-if="anunciosFiltrados.length === 0 && !anuncios.loading">
      <div class="card">
        <p style="text-align: center; color: #666;">No hay anuncios disponibles.</p>
      </div>
    </template>

    <template x-for="anuncio in anunciosFiltrados" :key="anuncio.id">
      <div class="card">
        <h3 x-text="anuncio.titulo"></h3>
        <p x-text="anuncio.contenido"></p>
        <small style="color: #666;">
          <strong>Fecha:</strong> <span x-text="formatDate(anuncio.fecha)"></span> |
          <strong>Autor:</strong> <span x-text="anuncio.autor"></span>
        </small>
      </div>
    </template>
  </div>

  <!-- Calendario Section -->
  <div id="calendario" class="section" x-data="calendarioAlumnoApp()" :class="{ 'active': $store.ui.isActive('calendario') }" x-init="initCalendar()">
    <div class="content-header">
      <h1><i class="fas fa-calendar"></i> Calendario de Eventos</h1>
    </div>
    <div id="calendar"></div>
  </div>

  <!-- Evaluaciones Section -->
  <div id="notas" class="section" x-data="evaluacionesAlumnoApp()" :class="{ 'active': $store.ui.isActive('notas') }">
    <div class="content-header">
      <h1><i class="fas fa-file-alt"></i> Mis Evaluaciones</h1>
    </div>

    <!-- Resumen de Niveles -->
    <div class="card">
      <h3>Resumen de Niveles de Logro</h3>
      <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
        <div class="stat-card logrado">
          <i class="fas fa-check-circle"></i>
          <div>
            <h4 x-text="resumen.L"></h4>
            <p>Logrado</p>
          </div>
        </div>
        <div class="stat-card en-desarrollo">
          <i class="fas fa-hourglass-half"></i>
          <div>
            <h4 x-text="resumen.OD"></h4>
            <p>En Desarrollo</p>
          </div>
        </div>
        <div class="stat-card no-logrado">
          <i class="fas fa-times-circle"></i>
          <div>
            <h4 x-text="resumen.NL"></h4>
            <p>No Logrado</p>
          </div>
        </div>
        <div class="stat-card no-trabajado">
          <i class="fas fa-minus-circle"></i>
          <div>
            <h4 x-text="resumen.NT"></h4>
            <p>No Trabajado</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <template x-if="notasAgrupadas.loading">
      <div class="card" style="text-align: center; padding: 40px; color: #667eea;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p style="margin-top: 15px;">Cargando evaluaciones...</p>
      </div>
    </template>

    <!-- Lista de Evaluaciones por Asignatura -->
    <template x-if="!notasAgrupadas.loading && asignaturas.length === 0">
      <div class="card">
        <p style="text-align: center; color: #666;">No hay evaluaciones registradas aún.</p>
      </div>
    </template>

    <template x-for="asig in asignaturas" :key="asig.nombre">
      <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-book"></i> <span x-text="asig.nombre"></span></h3>
        <div style="display: flex; gap: 15px; margin: 15px 0;">
          <span class="nivel-badge logrado" x-text="`L: ${asig.resumen?.L || 0}`"></span>
          <span class="nivel-badge en-desarrollo" x-text="`OD: ${asig.resumen?.OD || 0}`"></span>
          <span class="nivel-badge no-logrado" x-text="`NL: ${asig.resumen?.NL || 0}`"></span>
          <span class="nivel-badge no-trabajado" x-text="`NT: ${asig.resumen?.NT || 0}`"></span>
        </div>

        <table style="width: 100%; margin-top: 15px;">
          <thead>
            <tr>
              <th>Objetivo de Aprendizaje</th>
              <th>Nivel</th>
              <th>Fecha</th>
              <th>Observación</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="ev in asig.evaluaciones" :key="ev.id">
              <tr>
                <td x-text="ev.objetivoAprendizaje || ev.nombreEvaluacion || '-'"></td>
                <td><span class="nivel-badge" :class="getNivelClass(ev.nivelLogro || ev.evaluacionConceptual)" x-text="ev.nivelLogro || ev.evaluacionConceptual || 'NT'"></span></td>
                <td x-text="formatDate(ev.fecha)"></td>
                <td x-text="ev.observacion || ev.observaciones || '-'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Mis Promedios -->
    <template x-if="promedios.data && promedios.data.promediosPorAsignatura && promedios.data.promediosPorAsignatura.length > 0">
      <div class="card" style="margin-top: 25px;">
        <h3 style="margin-bottom: 20px;">
          <i class="fas fa-chart-line"></i> Mis Promedios
        </h3>

        <div class="promedio-general">
          <div class="promedio-general-content">
            <i class="fas fa-trophy fa-3x"></i>
            <div>
              <h2 x-text="promedios.data.promedioGeneral"></h2>
              <p>Mi Promedio General</p>
              <small x-text="`${promedios.data.totalNotas} evaluaciones`"></small>
            </div>
          </div>
        </div>

        <div class="promedios-grid">
          <template x-for="asig in promedios.data.promediosPorAsignatura" :key="asig.asignatura">
            <div class="promedio-card">
              <div class="promedio-card-header">
                <h4><i class="fas fa-book"></i> <span x-text="asig.asignatura"></span></h4>
                <span class="nivel-badge" :style="`background: ${getColorPromedio(asig.promedio)};`" x-text="getNivelLabel(asig.promedio)"></span>
              </div>

              <div class="promedio-bar-container">
                <div class="promedio-bar">
                  <div class="promedio-fill" :style="`width: ${(parseFloat(asig.promedio) / 4) * 100}%; background: ${getColorPromedio(asig.promedio)};`"></div>
                </div>
                <span class="promedio-porcentaje" x-text="`${((parseFloat(asig.promedio) / 4) * 100).toFixed(0)}%`"></span>
              </div>

              <div class="promedio-info">
                <div class="promedio-valor">
                  <span class="numero" x-text="asig.promedio"></span>
                  <span class="total">/ 4.0</span>
                </div>
                <span class="promedio-evaluaciones">
                  <i class="fas fa-clipboard-check"></i> <span x-text="`${asig.totalNotas} evaluaciones`"></span>
                </span>
              </div>
            </div>
          </template>
        </div>

        <div class="promedio-footer">
          <small><i class="fas fa-info-circle"></i> Los promedios representan tu desempeño: L=4.0 (Excelente), OD=3.0 (Bueno), NT=2.0, NL=1.0</small>
        </div>
      </div>
    </template>
  </div>

  <!-- Asistencia Section -->
  <div id="asistencia" class="section" x-data="asistenciaAlumnoApp()" :class="{ 'active': $store.ui.isActive('asistencia') }">
    <div class="content-header">
      <h1><i class="fas fa-calendar-check"></i> Mi Asistencia</h1>
    </div>

    <!-- Resumen -->
    <div class="card">
      <h3>Resumen del Mes</h3>
      <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
        <div class="stat-card presente">
          <i class="fas fa-check"></i>
          <div>
            <h4 x-text="resumen.presente"></h4>
            <p>Presente</p>
          </div>
        </div>
        <div class="stat-card ausente">
          <i class="fas fa-times"></i>
          <div>
            <h4 x-text="resumen.ausente"></h4>
            <p>Ausente</p>
          </div>
        </div>
        <div class="stat-card atrasado">
          <i class="fas fa-clock"></i>
          <div>
            <h4 x-text="resumen.atrasado"></h4>
            <p>Atrasado</p>
          </div>
        </div>
        <div class="stat-card porcentaje">
          <i class="fas fa-percentage"></i>
          <div>
            <h4 x-text="resumen.porcentaje + '%'"></h4>
            <p>Asistencia</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <template x-if="asistencia.loading">
      <div class="card" style="margin-top: 20px; text-align: center; padding: 40px; color: #667eea;">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p style="margin-top: 15px;">Cargando asistencia...</p>
      </div>
    </template>

    <!-- Registro de Asistencia -->
    <div class="card" style="margin-top: 20px;">
      <h3>Registro de Asistencia</h3>

      <template x-if="!asistencia.loading && registros.length === 0">
        <p style="text-align: center; color: #666;">No hay registros de asistencia.</p>
      </template>

      <template x-if="registros.length > 0">
        <table style="width: 100%; margin-top: 15px;">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Curso</th>
              <th>Estado</th>
              <th>Observación</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="r in registros" :key="r.id">
              <tr>
                <td x-text="formatDate(r.fecha)"></td>
                <td x-text="r.curso"></td>
                <td><span :class="`badge-${r.estado}`" x-text="getEstadoLabel(r.estado)"></span></td>
                <td x-text="r.observacion || '-'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>
    </div>
  </div>
</main>

<!-- Modal de evento -->
<div id="eventModal" class="modal" x-data="{ show: false }" :class="{ 'show': show }">
  <div class="modal-content">
    <span class="close" @click="show = false">&times;</span>
    <h3 id="eventTitle"></h3>
    <p><strong>Fecha:</strong> <span id="eventDate"></span></p>
    <p><strong>Hora:</strong> <span id="eventTime"></span></p>
    <p><strong>Curso:</strong> <span id="eventCurso"></span></p>
    <p><strong>Tipo:</strong> <span id="eventTipo"></span></p>
    <p id="eventDesc"></p>
  </div>
</div>

<script>
// ==============================================
// ANUNCIOS
// ==============================================
function anunciosAlumnoApp() {
  return {
    anuncios: useAnuncios(),

    get anunciosFiltrados() {
      if (!this.anuncios.data) return [];
      return this.anuncios.data.filter(a =>
        a.destinatarios === 'todos' || a.destinatarios === 'alumnos'
      );
    },

    formatDate(fecha) {
      return new Date(fecha).toLocaleDateString('es-CL');
    }
  };
}

// ==============================================
// CALENDARIO
// ==============================================
function calendarioAlumnoApp() {
  return {
    calendar: null,

    initCalendar() {
      const calendarEl = document.getElementById('calendar');
      this.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 600,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        events: async (fetchInfo, successCallback, failureCallback) => {
          try {
            const eventos = await apiClient.get('/eventos');
            successCallback(eventos.map(e => ({
              id: e.id,
              title: e.titulo,
              start: e.fecha + (e.hora ? 'T' + e.hora : ''),
              description: e.descripcion,
              extendedProps: { curso: e.curso, tipo: e.tipo }
            })));
          } catch (err) {
            failureCallback(err);
          }
        },
        eventClick: (info) => {
          const e = info.event;
          document.getElementById('eventTitle').textContent = e.title;
          document.getElementById('eventDate').textContent = e.startStr.split('T')[0];
          document.getElementById('eventTime').textContent = e.startStr.split('T')[1]?.substring(0, 5) || 'Todo el día';
          document.getElementById('eventCurso').textContent = e.extendedProps.curso || 'Todos';
          document.getElementById('eventTipo').textContent = e.extendedProps.tipo || 'Evento';
          document.getElementById('eventDesc').textContent = e.extendedProps.description || '';

          const modal = document.getElementById('eventModal');
          modal.style.display = 'flex';
          modal.classList.add('show');
        }
      });
      this.calendar.render();
    }
  };
}

// ==============================================
// EVALUACIONES
// ==============================================
function evaluacionesAlumnoApp() {
  const rutAlumno = sessionStorage.getItem('rutAlumno') || Alpine.store('auth').user?.rut || '';

  return {
    notasAgrupadas: useNotasAgrupadas(rutAlumno),
    promedios: usePromedios(rutAlumno),

    get asignaturas() {
      return this.notasAgrupadas.data?.asignaturas || [];
    },

    get resumen() {
      const totales = { L: 0, NL: 0, OD: 0, NT: 0 };
      this.asignaturas.forEach(asig => {
        if (asig.resumen) {
          totales.L += asig.resumen.L || 0;
          totales.NL += asig.resumen.NL || 0;
          totales.OD += asig.resumen.OD || 0;
          totales.NT += asig.resumen.NT || 0;
        }
      });
      return totales;
    },

    getNivelClass(nivel) {
      const map = {
        'L': 'logrado',
        'NL': 'no-logrado',
        'OD': 'en-desarrollo',
        'NT': 'no-trabajado'
      };
      return map[nivel] || 'no-trabajado';
    },

    getColorPromedio(promedio) {
      const p = parseFloat(promedio);
      if (p >= 3.5) return '#4caf50';
      if (p >= 3.0) return '#8bc34a';
      if (p >= 2.5) return '#ff9800';
      return '#f44336';
    },

    getNivelLabel(promedio) {
      const p = parseFloat(promedio);
      if (p >= 3.5) return 'Excelente';
      if (p >= 3.0) return 'Bueno';
      if (p >= 2.5) return 'Regular';
      return 'Necesita Apoyo';
    },

    formatDate(fecha) {
      return new Date(fecha).toLocaleDateString('es-CL');
    }
  };
}

// ==============================================
// ASISTENCIA
// ==============================================
function asistenciaAlumnoApp() {
  const rutAlumno = sessionStorage.getItem('rutAlumno') || Alpine.store('auth').user?.rut || '';

  return {
    asistencia: useAsistenciaAlumno(rutAlumno),

    get registros() {
      return this.asistencia.data || [];
    },

    get resumen() {
      const totales = { presente: 0, ausente: 0, atrasado: 0 };
      this.registros.forEach(r => {
        if (r.estado in totales) totales[r.estado]++;
      });

      const total = this.registros.length;
      const porcentaje = total > 0 ? ((totales.presente / total) * 100).toFixed(1) : 0;

      return { ...totales, porcentaje };
    },

    getEstadoLabel(estado) {
      const map = {
        'presente': '✅ Presente',
        'ausente': '❌ Ausente',
        'atrasado': '⏰ Atrasado'
      };
      return map[estado] || estado;
    },

    formatDate(fecha) {
      return new Date(fecha).toLocaleDateString('es-CL');
    }
  };
}
</script>

</body>
</html>