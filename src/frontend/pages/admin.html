<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Admin - Boy Happy</title>
<link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<!-- Export Libraries (CU-25) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<!-- Chart.js (CU-23) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- CDN externos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- STYLES -->
<!-- Lambda inyecta CSS inline aquí -->

<!-- SCRIPT -->
<!-- Lambda inyecta JS inline aquí -->

<!-- Alpine.js al FINAL con defer: inicia después de que todos los stores se registren -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data>
<aside class="sidebar">
  <div class="sidebar-logo">
    <i class="fas fa-graduation-cap"></i>
    <span>Boy Happy</span>
  </div>

  <ul class="sidebar-menu">
    <li><a href="#" @click.prevent="$store.ui.navigateTo('dashboard')" :class="{ 'active': $store.ui.isActive('dashboard') }"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('comparativo')" :class="{ 'active': $store.ui.isActive('comparativo') }"><i class="fas fa-chart-line"></i> Comparativo Cursos</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('usuarios')" :class="{ 'active': $store.ui.isActive('usuarios') }"><i class="fas fa-users"></i> Gestión de Usuarios</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('matriculas')" :class="{ 'active': $store.ui.isActive('matriculas') }"><i class="fas fa-file-alt"></i> Matrículas</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('asistencia')" :class="{ 'active': $store.ui.isActive('asistencia') }"><i class="fas fa-calendar-check"></i> Asistencia</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('materiales')" :class="{ 'active': $store.ui.isActive('materiales') }"><i class="fas fa-folder-open"></i> Materiales</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('comunicaciones')" :class="{ 'active': $store.ui.isActive('comunicaciones') }"><i class="fas fa-bullhorn"></i> Comunicaciones</a></li>
    <li><a href="#" @click.prevent="$store.ui.navigateTo('configuracion')" :class="{ 'active': $store.ui.isActive('configuracion') }"><i class="fas fa-cogs"></i> Configuración</a></li>
  </ul>
  <button class="logout-btn" @click="cerrarSesion()">
    <i class="fas fa-sign-out-alt"></i>
    <span>Cerrar Sesión</span>
  </button>
</aside>

<main class="main-content">
  <!-- ⭐ Dashboard Section - SHAREDIFICADO con Alpine.js + Hooks -->
  <div id="dashboard" class="section" x-data="dashboardApp()" :class="{ 'active': $store.ui.isActive('dashboard') }">
    <div class="content-header">
      <h1><i class="fas fa-tachometer-alt"></i> Dashboard de Indicadores</h1>
    </div>

    <!-- Loading State -->
    <template x-if="loading && !data">
      <div style="text-align: center; padding: 60px 20px; color: #667eea;">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top: 15px; font-size: 1.1em;">Cargando dashboard...</p>
      </div>
    </template>

    <!-- Dashboard Content (solo visible cuando hay datos) -->
    <template x-if="data">
      <div>
        <!-- Indicadores Principales -->
        <div class="dashboard-grid">
          <!-- Usuarios Activos -->
          <div class="indicator-card">
            <div class="indicator-header">
              <i class="fas fa-users fa-2x"></i>
              <h3>Usuarios Activos</h3>
            </div>
            <div class="indicator-value" x-text="indicadores.totalUsuarios"></div>
            <div class="indicator-trend">
              <small style="color: #4caf50;">
                <i class="fas fa-arrow-up"></i>
                <span x-text="indicadores.trendUsuarios"></span>
              </small>
            </div>
          </div>

          <!-- Asistencia Promedio -->
          <div class="indicator-card">
            <div class="indicator-header">
              <i class="fas fa-calendar-check fa-2x"></i>
              <h3>Asistencia Promedio</h3>
            </div>
            <div class="indicator-value" x-text="indicadores.promedioAsistencia"></div>
            <div class="indicator-semaphore" style="display: flex; flex-direction: row; gap: 8px; align-items: center; justify-content: center;">
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoAsistencia === 'red' }"
                   :style="indicadores.semaforoAsistencia === 'red' ? 'background: #f44336' : 'background: #ddd'"></div>
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoAsistencia === 'yellow' }"
                   :style="indicadores.semaforoAsistencia === 'yellow' ? 'background: #ff9800' : 'background: #ddd'"></div>
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoAsistencia === 'green' }"
                   :style="indicadores.semaforoAsistencia === 'green' ? 'background: #4caf50' : 'background: #ddd'"></div>
            </div>
          </div>

          <!-- Materiales Activos -->
          <div class="indicator-card">
            <div class="indicator-header">
              <i class="fas fa-folder fa-2x"></i>
              <h3>Materiales Activos</h3>
            </div>
            <div class="indicator-value" x-text="indicadores.materialesActivos"></div>
            <div class="indicator-semaphore" style="display: flex; flex-direction: row; gap: 8px; align-items: center; justify-content: center;">
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoMateriales === 'red' }"
                   :style="indicadores.semaforoMateriales === 'red' ? 'background: #f44336' : 'background: #ddd'"></div>
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoMateriales === 'yellow' }"
                   :style="indicadores.semaforoMateriales === 'yellow' ? 'background: #ff9800' : 'background: #ddd'"></div>
              <div class="semaphore-light"
                   :class="{ active: indicadores.semaforoMateriales === 'green' }"
                   :style="indicadores.semaforoMateriales === 'green' ? 'background: #4caf50' : 'background: #ddd'"></div>
            </div>
          </div>
        </div>

        <!-- Alertas Críticas -->
        <div class="card" style="margin-top: 25px;">
          <h3><i class="fas fa-exclamation-triangle"></i> Alertas y Acciones Requeridas</h3>
          <div style="margin-top: 15px;">
            <template x-if="alertas.length === 0">
              <p style="color: #4caf50; text-align: center;">
                <i class="fas fa-check-circle"></i> No hay alertas críticas
              </p>
            </template>

            <template x-for="alerta in alertas" :key="alerta.mensaje">
              <div :style="`padding: 15px; margin-bottom: 10px; border-radius: 8px; background: ${alerta.color}15; border-left: 4px solid ${alerta.color}; display: flex; justify-content: space-between; align-items: center;`">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <i :class="'fas ' + alerta.icono" :style="`color: ${alerta.color}; font-size: 1.5em;`"></i>
                  <div>
                    <strong x-text="alerta.mensaje" :style="`color: ${alerta.color};`"></strong>
                    <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                      Prioridad: <span x-text="alerta.prioridad.toUpperCase()"></span>
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm" :style="`background: ${alerta.color}; color: white;`"
                        @click="showSection(alerta.seccion)">
                  <i class="fas fa-arrow-right"></i>
                  <span x-text="alerta.accion"></span>
                </button>
              </div>
            </template>
          </div>
        </div>

        <!-- Resumen por Curso -->
        <div class="card" style="margin-top: 25px;">
          <h3><i class="fas fa-chart-bar"></i> Resumen por Curso</h3>

          <!-- Mensaje si no hay datos -->
          <template x-if="resumenCursos.length === 0">
            <p style="text-align: center; color: #999; padding: 40px;">
              <i class="fas fa-info-circle"></i> No hay datos de cursos disponibles
            </p>
          </template>

          <!-- Grid de cursos -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
            <template x-for="(curso, index) in resumenCursos" :key="curso.codigo">
              <div class="card"
                   :style="`background: white; border: 3px solid ${$store.utils.getCursoColor(index)}; color: #333; padding: 20px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);`"
                   @click="console.log('Click en curso:', curso.codigo)"
                   @mouseenter="$el.style.transform = 'translateY(-4px)'; $el.style.boxShadow = '0 8px 16px rgba(0,0,0,0.15)'"
                   @mouseleave="$el.style.transform = 'translateY(0)'; $el.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)'">

                <!-- Nombre del curso con semáforo -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <h4 :style="`margin: 0; color: ${$store.utils.getCursoColor(index)}; font-weight: 600;`" x-text="curso.nombre"></h4>
                  <div class="semaphore-light active"
                       :style="`width: 16px; height: 16px; background: ${curso.semaforoColor}; box-shadow: 0 0 8px ${curso.semaforoColor};`">
                  </div>
                </div>

                <!-- Métricas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">
                      <i class="fas fa-users" :style="`color: ${$store.utils.getCursoColor(index)}`"></i> Alumnos
                    </div>
                    <div :style="`font-size: 1.6em; font-weight: bold; color: ${$store.utils.getCursoColor(index)};`" x-text="curso.alumnos"></div>
                  </div>

                  <div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">
                      <i class="fas fa-calendar-check" :style="`color: ${$store.utils.getCursoColor(index)}`"></i> Asistencia
                    </div>
                    <div :style="`font-size: 1.6em; font-weight: bold; color: ${$store.utils.getCursoColor(index)};`" x-text="curso.asistencia"></div>
                  </div>
                </div>

                <!-- Materiales -->
                <div :style="`margin-top: 15px; padding-top: 15px; border-top: 2px solid ${$store.utils.getCursoColor(index)}33;`">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.85em; color: #666;">
                      <i class="fas fa-book" :style="`color: ${$store.utils.getCursoColor(index)}`"></i> Materiales publicados
                    </span>
                    <span :style="`font-size: 1.1em; font-weight: bold; color: ${$store.utils.getCursoColor(index)};`" x-text="`${curso.materialesPublicados}/${curso.materialesTotal}`"></span>
                  </div>
                </div>

                <!-- Detalle de registros -->
                <div style="margin-top: 10px; font-size: 0.75em; color: #999; text-align: right;">
                  <span x-text="`${curso.registrosAsistencia} registros`"></span>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Comparativo Multi-Curso Section (CU-23) - MIGRADO A ALPINE -->
  <div id="comparativo" class="section" x-data="comparativoApp()" :class="{ 'active': $store.ui.isActive('comparativo') }">
    <div class="content-header">
      <h1><i class="fas fa-chart-line"></i> Comparativo Multi-Curso</h1>
    </div>

    <!-- Loading State -->
    <template x-if="loading">
      <div style="text-align: center; padding: 60px 20px; color: #667eea;">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top: 15px; font-size: 1.1em;">Cargando datos comparativos...</p>
      </div>
    </template>

    <!-- Selector de Cursos -->
    <div class="card">
      <h3><i class="fas fa-filter"></i> Seleccionar Cursos para Comparar</h3>
      <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
        <template x-for="curso in cursos" :key="curso.codigo">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox"
                   :value="curso.codigo"
                   x-model="cursosSeleccionados"
                   class="curso-checkbox">
            <span x-text="curso.nombre"></span>
          </label>
        </template>
      </div>

      <!-- Filtro de Período -->
      <div class="form-row" style="margin-top: 20px;">
        <div class="form-group">
          <label>Período Desde</label>
          <input type="date" x-model="fechaInicio">
        </div>
        <div class="form-group">
          <label>Período Hasta</label>
          <input type="date" x-model="fechaFin">
        </div>
      </div>
    </div>

    <!-- Gráfico de Asistencia -->
    <div class="card" style="margin-top: 25px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3><i class="fas fa-chart-bar"></i> Asistencia Promedio por Curso</h3>
        <button class="btn btn-sm btn-success" @click="exportarGrafico('chartAsistencia', 'asistencia_comparativo')">
          <i class="fas fa-download"></i> Exportar PNG
        </button>
      </div>
      <canvas id="chartAsistencia" style="max-height: 400px;"></canvas>
    </div>

    <!-- Gráfico de Evolución Temporal -->
    <div class="card" style="margin-top: 25px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3><i class="fas fa-chart-line"></i> Evolución de Asistencia en el Tiempo</h3>
        <button class="btn btn-sm btn-success" @click="exportarGrafico('chartEvolucion', 'evolucion_asistencia')">
          <i class="fas fa-download"></i> Exportar PNG
        </button>
      </div>
      <canvas id="chartEvolucion" style="max-height: 400px;"></canvas>
    </div>

    <!-- Gráfico de Niveles de Logro -->
    <div class="card" style="margin-top: 25px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3><i class="fas fa-chart-pie"></i> Distribución de Niveles de Logro</h3>
        <button class="btn btn-sm btn-success" @click="exportarGrafico('chartNiveles', 'niveles_logro')">
          <i class="fas fa-download"></i> Exportar PNG
        </button>
      </div>
      <canvas id="chartNiveles" style="max-height: 400px;"></canvas>
    </div>

    <!-- Tabla Comparativa -->
    <div class="card" style="margin-top: 25px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3><i class="fas fa-table"></i> Resumen Numérico Comparativo</h3>
        <button class="btn btn-sm btn-success" @click="exportarTablaExcel()">
          <i class="fas fa-file-excel"></i> Exportar a Excel
        </button>
      </div>

      <!-- Tabla renderizada con Alpine -->
      <template x-if="datosComparativos.length > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Curso</th>
              <th>Asistencia (%)</th>
              <th>Total Evaluaciones</th>
              <th>Logrado (L)</th>
              <th>En Desarrollo (OD)</th>
              <th>No Logrado (NL)</th>
              <th>No Trabajado (NT)</th>
              <th>Promedio</th>
              <th>Materiales</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="d in datosComparativos" :key="d.codigo">
              <tr>
                <td><strong x-text="d.curso"></strong></td>
                <td :style="`background: ${getColorFondo(d.asistencia)};`" x-text="d.asistencia + '%'"></td>
                <td x-text="d.totalEvaluaciones"></td>
                <td x-text="d.logrado"></td>
                <td x-text="d.enDesarrollo"></td>
                <td x-text="d.noLogrado"></td>
                <td x-text="d.noTrabajado"></td>
                <td><strong x-text="d.promedioNumerico"></strong></td>
                <td x-text="d.materiales"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>

      <template x-if="datosComparativos.length === 0">
        <p style="text-align: center; color: #999; padding: 40px;">
          <i class="fas fa-info-circle"></i> Selecciona cursos y período para ver el comparativo
        </p>
      </template>
    </div>
  </div>


  <!-- Matrículas Section - MIGRADO A ALPINE.JS -->
  <div id="matriculas" class="section" x-data="matriculasApp()" :class="{ 'active': $store.ui.isActive('matriculas') }">
    <div class="content-header">
      <h1><i class="fas fa-file-alt"></i> Solicitudes de Matrícula</h1>
    </div>

    <!-- Estadísticas -->
    <div class="dashboard-grid" style="margin-bottom: 25px;">
      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-clock fa-2x" style="color: #ff9800;"></i>
          <h3>Pendientes</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.pendientes"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-check-circle fa-2x" style="color: #4caf50;"></i>
          <h3>Aprobadas</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.aprobadas"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-times-circle fa-2x" style="color: #f44336;"></i>
          <h3>Rechazadas</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.rechazadas"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-file-alt fa-2x" style="color: #667eea;"></i>
          <h3>Total</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.total"></div>
      </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card" style="margin-bottom: 20px;">
      <h3><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>

      <!-- Buscador -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label><i class="fas fa-search"></i> Buscar</label>
        <input
          type="text"
          x-model="busqueda"
          placeholder="Buscar por nombre alumno, apoderado, email, RUT o teléfono..."
          style="width: 100%;">
      </div>

      <!-- Filtros -->
      <div class="form-row">
        <div class="form-group">
          <label>Estado</label>
          <select x-model="filtroEstado">
            <option value="">Todas</option>
            <option value="pendiente">Pendientes</option>
            <option value="aprobada">Aprobadas</option>
            <option value="rechazada">Rechazadas</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha Desde</label>
          <input type="date" x-model="fechaDesde">
        </div>

        <div class="form-group">
          <label>Fecha Hasta</label>
          <input type="date" x-model="fechaHasta">
        </div>

        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button class="btn btn-secondary" @click="limpiarFiltros()" style="width: 100%;">
            <i class="fas fa-times"></i> Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <template x-if="matriculas.loading && !matriculas.data">
      <div class="card" style="text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
        <p style="margin-top: 15px;">Cargando solicitudes...</p>
      </div>
    </template>

    <!-- Lista de Matrículas -->
    <template x-if="matriculas.data">
      <div class="card">
        <h3 x-text="`Solicitudes (${matriculasFiltradas.length})`"></h3>

        <template x-if="matriculasFiltradas.length === 0">
          <p style="text-align: center; color: #666; padding: 30px;">
            No hay solicitudes de matrícula
          </p>
        </template>

        <template x-if="matriculasFiltradas.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nombre Alumno</th>
                <th>Nombre Apoderado</th>
                <th>RUT Alumno</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Curso</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="mat in matriculasFiltradas" :key="mat.id">
                <tr>
                  <td><strong x-text="mat.nombreAlumno"></strong></td>
                  <td x-text="mat.nombreApoderado || '-'"></td>
                  <td x-text="mat.rutAlumno"></td>
                  <td x-text="mat.correoApoderado"></td>
                  <td x-text="mat.telefonoApoderado || '-'"></td>
                  <td x-text="mat.curso || '-'"></td>
                  <td x-text="formatDate(mat.fecha)"></td>
                  <td>
                    <span :style="`background: ${getEstadoColor(mat.estado)}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;`"
                          x-text="getEstadoTexto(mat.estado)"></span>
                  </td>
                  <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                      <button class="btn btn-sm btn-primary" @click="verDetalle(mat)" title="Ver Detalle">
                        <i class="fas fa-eye"></i>
                      </button>

                      <template x-if="mat.estado === 'pendiente'">
                        <button class="btn btn-sm btn-success" @click="aprobarMatricula(mat)" title="Aprobar">
                          <i class="fas fa-check"></i>
                        </button>
                      </template>

                      <template x-if="mat.estado === 'pendiente'">
                        <button class="btn btn-sm btn-danger" @click="rechazarMatricula(mat)" title="Rechazar">
                          <i class="fas fa-times"></i>
                        </button>
                      </template>

                      <template x-if="mat.estado === 'aprobada' && !mat.usuarioCreado">
                        <button class="btn btn-sm btn-success" @click="crearUsuarioDesdeMatricula(mat)" title="Crear Usuario">
                          <i class="fas fa-user-plus"></i>
                        </button>
                      </template>

                      <template x-if="mat.usuarioCreado">
                        <span style="color: #4caf50; font-size: 0.85em; padding: 6px;">
                          <i class="fas fa-check-circle"></i> Usuario creado
                        </span>
                      </template>

                      <template x-if="!mat.usuarioCreado">
                        <button class="btn btn-sm btn-danger" @click="eliminarMatricula(mat)" title="Eliminar">
                          <i class="fas fa-trash"></i>
                        </button>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </template>
      </div>
    </template>
  </div>

  <!-- Asistencia Section -->
  <!-- ✅ Asistencia Section - MIGRADO A ALPINE.JS -->
  <div id="asistencia" class="section" x-data="asistenciaApp()" :class="{ 'active': $store.ui.isActive('asistencia') }">
    <div class="content-header">
      <h1><i class="fas fa-calendar-check"></i> Supervisión de Asistencia</h1>
    </div>

    <div class="card">
      <h3><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>

      <!-- Buscador -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label><i class="fas fa-search"></i> Buscar Alumno</label>
        <input
          type="text"
          x-model="busqueda"
          placeholder="Buscar por nombre o RUT del alumno..."
          style="width: 100%;">
      </div>

      <!-- Filtros -->
      <div class="form-row">
        <div class="form-group">
          <label>Curso</label>
          <select x-model="filtros.curso" @change="aplicarFiltros()">
            <option value="">Todos los cursos</option>
            <template x-for="curso in cursos" :key="curso.codigo">
              <option :value="curso.codigo" x-text="curso.nombre"></option>
            </template>
          </select>
        </div>

        <div class="form-group">
          <label>Estado</label>
          <select x-model="filtros.estado">
            <option value="">Todos</option>
            <option value="presente">Presente</option>
            <option value="ausente">Ausente</option>
            <option value="atrasado">Atrasado</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha Desde</label>
          <input type="date" x-model="filtros.fechaInicio">
        </div>

        <div class="form-group">
          <label>Fecha Hasta</label>
          <input type="date" x-model="filtros.fechaFin">
        </div>

        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button class="btn btn-secondary" @click="limpiarFiltros()" style="width: 100%;">
            <i class="fas fa-times"></i> Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div :style="(asistencia.loading && !asistencia.data) ? '' : 'display: none'" class="card" style="margin-top: 20px; text-align: center; padding: 40px;">
      <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
      <p style="margin-top: 15px;">Cargando asistencia...</p>
    </div>

    <!-- Resumen General -->
    <div :style="asistencia.data ? '' : 'display: none'">
      <div>
        <div class="card" style="margin-top: 20px;">
          <h3>Resumen General</h3>
          <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
            <div class="stat-card presente">
              <i class="fas fa-check"></i>
              <div>
                <h4 x-text="resumen.presente"></h4>
                <p>Presentes</p>
              </div>
            </div>
            <div class="stat-card ausente">
              <i class="fas fa-times"></i>
              <div>
                <h4 x-text="resumen.ausente"></h4>
                <p>Ausentes</p>
              </div>
            </div>
            <div class="stat-card atrasado">
              <i class="fas fa-clock"></i>
              <div>
                <h4 x-text="resumen.atrasado"></h4>
                <p>Atrasados</p>
              </div>
            </div>
            <div class="stat-card porcentaje">
              <i class="fas fa-percentage"></i>
              <div>
                <h4 x-text="resumen.porcentaje + '%'"></h4>
                <p>Asistencia</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Detalle por Alumno -->
        <div class="card" style="margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Detalle por Alumno (<span x-text="detalleAlumnosFiltrados.length"></span>)</h3>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-success btn-sm" @click="exportarExcel()" title="Exportar a Excel">
                <i class="fas fa-file-excel"></i> Excel
              </button>
              <button class="btn btn-danger btn-sm" @click="exportarPDF()" title="Exportar a PDF">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>

          <p :style="(detalleAlumnosFiltrados && detalleAlumnosFiltrados.length === 0) ? '' : 'display: none'" style="text-align: center; padding: 30px; color: #999;">
            No hay registros de asistencia para los filtros seleccionados.
          </p>

          <table :style="(detalleAlumnosFiltrados && detalleAlumnosFiltrados.length > 0) ? '' : 'display: none'" class="data-table" style="width: 100%; margin-top: 15px;">
              <thead>
                <tr>
                  <th>Alumno</th>
                  <th>RUT</th>
                  <th>Curso</th>
                  <th>Presente</th>
                  <th>Ausente</th>
                  <th>Atrasado</th>
                  <th>Total Días</th>
                  <th>% Asistencia</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="a in (detalleAlumnosFiltrados || [])" :key="a.rut">
                  <tr :style="a.tieneAlerta ? 'background-color: #fff3cd;' : ''">
                    <td><strong x-text="a.nombre"></strong></td>
                    <td x-text="a.rut"></td>
                    <td x-text="a.curso"></td>
                    <td><span class="badge-presente" x-text="a.presente"></span></td>
                    <td><span class="badge-ausente" x-text="a.ausente"></span></td>
                    <td><span class="badge-atrasado" x-text="a.atrasado"></span></td>
                    <td x-text="a.total"></td>
                    <td>
                      <strong x-text="a.porcentaje + '%'" :style="`color: ${a.porcentaje >= 85 ? '#4caf50' : a.porcentaje >= 70 ? '#ff9800' : '#f44336'}`"></strong>
                    </td>
                    <td>
                      <span :style="a.porcentaje >= 85 ? '' : 'display: none'" style="color: #4caf50;">
                        <i class="fas fa-check-circle"></i> Excelente
                      </span>
                      <span :style="a.porcentaje >= 70 && a.porcentaje < 85 ? '' : 'display: none'" style="color: #ff9800;">
                        <i class="fas fa-exclamation-triangle"></i> Regular
                      </span>
                      <span :style="a.porcentaje < 70 ? '' : 'display: none'" style="color: #f44336;">
                        <i class="fas fa-times-circle"></i> Crítico
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" @click="verHistorialAlumno(a)" title="Ver Historial">
                        <i class="fas fa-history"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Comunicaciones Section -->
  <!-- ✅ Comunicaciones Section - MIGRADO A ALPINE.JS -->
  <div id="comunicaciones" class="section" x-data="{ tabActiva: 'anuncios' }" :class="{ 'active': $store.ui.isActive('comunicaciones') }">
    <div class="content-header">
      <h1><i class="fas fa-bullhorn"></i> Comunicaciones</h1>
    </div>

    <!-- Tabs de Comunicaciones -->
    <div class="tabs-container" style="margin-bottom: 20px;">
      <button class="tab-btn" :class="{ 'active': tabActiva === 'anuncios' }" @click="tabActiva = 'anuncios'">
        <i class="fas fa-bullhorn"></i> Anuncios
      </button>
      <button class="tab-btn" :class="{ 'active': tabActiva === 'notificaciones' }" @click="tabActiva = 'notificaciones'">
        <i class="fas fa-envelope"></i> Notificaciones
      </button>
      <button class="tab-btn" :class="{ 'active': tabActiva === 'retroalimentacion' }" @click="tabActiva = 'retroalimentacion'">
        <i class="fas fa-comments"></i> Retroalimentación
      </button>
    </div>

    <!-- Tab: Anuncios -->
    <div x-show="tabActiva === 'anuncios'" x-data="anunciosApp()">
      <div class="card">
        <h3><i class="fas fa-bullhorn"></i> Publicar Nuevo Anuncio</h3>
        <form @submit.prevent="publicarAnuncio()">
          <div class="form-group">
            <label>Título del Anuncio *</label>
            <input type="text" x-model="nuevoAnuncio.titulo" placeholder="Título" required>
          </div>
          <div class="form-group">
            <label>Contenido *</label>
            <textarea x-model="nuevoAnuncio.contenido" placeholder="Contenido del anuncio" required style="height: 120px;"></textarea>
          </div>
          <div class="form-group">
            <label>Destinatarios</label>
            <select x-model="nuevoAnuncio.destinatarios">
              <option value="todos">Todos</option>
              <option value="profesores">Solo Profesores</option>
              <option value="alumnos">Solo Alumnos</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-bullhorn"></i> Publicar Anuncio
          </button>
        </form>
      </div>

      <!-- Lista de Anuncios -->
      <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-list"></i> Anuncios Publicados (<span x-text="anunciosFiltrados.length"></span>)</h3>

        <!-- Loading state -->
        <div x-show="anuncios.loading && !anuncios.data" style="text-align: center; padding: 30px;">
          <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
          <p style="margin-top: 10px; color: #666;">Cargando anuncios...</p>
        </div>

        <!-- Empty state -->
        <div :style="!anuncios.loading && anunciosFiltrados.length === 0 ? '' : 'display: none'" style="text-align: center; padding: 30px; color: #999;">
          <i class="fas fa-inbox fa-3x" style="margin-bottom: 10px;"></i>
          <p>No hay anuncios publicados</p>
        </div>

        <!-- Lista -->
        <div :style="anunciosFiltrados.length > 0 ? '' : 'display: none'">
          <template x-for="(anuncio, index) in anunciosFiltrados" :key="`anuncio-${anuncio.timestamp || index}`">
            <div class="card" style="margin-bottom: 15px; background: #f8f9fa; border-left: 4px solid #667eea;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 10px 0; color: #333;" x-text="anuncio.titulo"></h4>
                  <p style="margin: 0 0 10px 0; color: #666; white-space: pre-wrap;" x-text="anuncio.contenido"></p>
                  <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #999;">
                    <span><i class="fas fa-calendar"></i> <span x-text="formatDate(anuncio.fecha)"></span></span>
                    <span><i class="fas fa-user"></i> <span x-text="anuncio.autor || 'Admin'"></span></span>
                    <span><i class="fas fa-users"></i> <span x-text="getDestinatariosLabel(anuncio.destinatarios)"></span></span>
                  </div>
                </div>
                <button @click="eliminarAnuncio(anuncio)" class="btn btn-danger btn-sm" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Tab: Notificaciones -->
    <div x-show="tabActiva === 'notificaciones'" x-data="notificacionesApp()">
      <div class="card">
        <h3><i class="fas fa-envelope"></i> Enviar Notificación por Email</h3>
        <form @submit.prevent="enviarNotificacion()">
          <div class="form-group">
            <label>Destinatarios *</label>
            <select x-model="notificacion.destinatarios">
              <option value="todos">Todos los usuarios</option>
              <option value="admin">Solo Administradores</option>
              <option value="profesor">Solo Profesores</option>
              <option value="fono">Solo Fonoaudiólogos</option>
              <option value="alumno">Solo Alumnos/Apoderados</option>
            </select>
          </div>

          <div class="form-group">
            <label>Asunto *</label>
            <input type="text" x-model="notificacion.asunto" placeholder="Asunto del correo" required>
          </div>

          <div class="form-group">
            <label>Mensaje *</label>
            <textarea x-model="notificacion.mensaje" placeholder="Contenido del mensaje..." required style="height: 200px;"></textarea>
          </div>

          <button type="submit" class="btn btn-primary" :disabled="enviando">
            <i class="fas fa-paper-plane"></i>
            <span x-text="enviando ? 'Enviando...' : 'Enviar Email'"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- Tab: Retroalimentación -->
    <div x-show="tabActiva === 'retroalimentacion'" x-data="retroalimentacionApp()">
      <!-- CU-20: Enviar Retroalimentación -->
      <div class="card">
        <h3><i class="fas fa-plus-circle"></i> Enviar Nueva Retroalimentación</h3>
        <form @submit.prevent="enviarRetroalimentacion()">
          <div class="form-row">
            <div class="form-group">
              <label>Usuario *</label>
              <select x-model="nuevaRetro.rutUsuario" required>
                <option value="">-- Seleccionar usuario --</option>
                <template x-for="u in usuariosDisponibles" :key="u.rut">
                  <option :value="u.rut" x-text="`${u.nombre} ${u.apellido || ''} (${u.rut})`"></option>
                </template>
              </select>
            </div>

            <div class="form-group">
              <label>Tipo de Retroalimentación *</label>
              <select x-model="nuevaRetro.tipo" required>
                <option value="">-- Seleccionar tipo --</option>
                <option value="desempeno_general">📊 Desempeño General</option>
                <option value="conducta">🎭 Conducta</option>
                <option value="logro_destacado">⭐ Logro Destacado</option>
                <option value="area_mejora">📈 Área de Mejora</option>
                <option value="observacion_general">📝 Observación General</option>
                <option value="retroalimentacion_padres">👨‍👩‍👧 Retroalimentación a Padres</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Contenido *</label>
            <textarea x-model="nuevaRetro.comentario" rows="5" required
                      placeholder="Escribe tu retroalimentación aquí... Sé específico y constructivo."></textarea>
            <small style="color: #666; display: block; margin-top: 5px;">
              <i class="fas fa-lightbulb"></i> Tip: Una buena retroalimentación es específica, constructiva y orientada a la mejora.
            </small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Visibilidad</label>
              <select x-model="nuevaRetro.visibilidad">
                <option value="privada">🔒 Privada (solo admin/dirección)</option>
                <option value="publica">🌐 Pública (visible para el usuario)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Ámbito (Opcional)</label>
              <select x-model="nuevaRetro.ambito">
                <option value="">-- Sin especificar --</option>
                <option value="academico">📚 Académico</option>
                <option value="conductual">🎯 Conductual</option>
                <option value="socioemocional">❤️ Socioemocional</option>
                <option value="psicomotor">🤸 Psicomotor</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Curso (Opcional)</label>
            <select x-model="nuevaRetro.curso">
              <template x-for="c in cursos" :key="c.codigo">
                <option :value="c.codigo" x-text="c.nombre"></option>
              </template>
            </select>
          </div>

          <button type="submit" class="btn btn-success">
            <i class="fas fa-paper-plane"></i> Enviar Retroalimentación
          </button>
        </form>
      </div>

      <!-- CU-22: Ver Historial de Retroalimentación -->
      <div class="card" style="margin-top: 25px;">
        <h3><i class="fas fa-history"></i> Historial de Retroalimentación</h3>

        <!-- Filtros -->
        <div class="form-row">
          <div class="form-group">
            <label>Buscar por Usuario:</label>
            <select x-model="filtros.rutUsuario">
              <option value="">-- Todos los usuarios --</option>
              <template x-for="u in usuariosDisponibles" :key="u.rut">
                <option :value="u.rut" x-text="`${u.nombre} ${u.apellido || ''}`"></option>
              </template>
            </select>
          </div>

          <div class="form-group">
            <label>Filtrar por Tipo:</label>
            <select x-model="filtros.tipo">
              <option value="">Todos los tipos</option>
              <option value="desempeno_general">Desempeño General</option>
              <option value="conducta">Conducta</option>
              <option value="logro_destacado">Logro Destacado</option>
              <option value="area_mejora">Área de Mejora</option>
              <option value="observacion_general">Observación General</option>
              <option value="retroalimentacion_padres">Retroalimentación a Padres</option>
            </select>
          </div>
        </div>

        <!-- Loading state -->
        <div x-show="retroalimentaciones.loading && !retroalimentaciones.data" style="text-align: center; padding: 30px;">
          <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
          <p style="margin-top: 10px; color: #666;">Cargando retroalimentaciones...</p>
        </div>

        <!-- Empty state -->
        <div x-show="!retroalimentaciones.loading && retroalimentacionesFiltradas.length === 0" style="text-align: center; padding: 30px; color: #999;">
          <i class="fas fa-inbox fa-3x" style="margin-bottom: 10px;"></i>
          <p>No hay retroalimentaciones registradas</p>
        </div>

        <!-- Lista de retroalimentaciones -->
        <div x-show="retroalimentacionesFiltradas.length > 0" style="margin-top: 20px;">
          <template x-for="(retro, index) in retroalimentacionesFiltradas" :key="`retro-${retro.timestamp || index}`">
            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #9333ea;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div>
                  <h4 style="margin: 0; color: #333;">
                    <span x-text="getTipoIcon(retro.tipo)"></span>
                    <span x-text="retro.nombreUsuario"></span>
                  </h4>
                  <div style="display: flex; gap: 10px; margin-top: 5px; font-size: 0.85rem; color: #999;">
                    <span><i class="fas fa-calendar"></i> <span x-text="formatDateShort(retro.fecha)"></span></span>
                    <span x-text="getTipoLabel(retro.tipo)"></span>
                    <span x-show="retro.ambito" x-text="getAmbitoLabel(retro.ambito)"></span>
                    <span x-show="retro.visibilidad === 'privada'">🔒 Privada</span>
                  </div>
                </div>
                <div style="display: flex; gap: 5px;">
                  <button x-show="!retro.leida" @click="marcarComoLeida(retro)" class="btn btn-sm btn-success" title="Marcar como leída">
                    <i class="fas fa-check"></i>
                  </button>
                  <button @click="eliminarRetroalimentacion(retro)" class="btn btn-sm btn-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <p style="margin: 10px 0 0 0; color: #666; white-space: pre-wrap;" x-text="retro.comentario"></p>
              <div x-show="retro.creadoPor" style="margin-top: 10px; font-size: 0.85rem; color: #999;">
                <i class="fas fa-user"></i> Creado por: <span x-text="retro.creadoPor"></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Materiales Section - MIGRADO A ALPINE.JS -->
  <div id="materiales" class="section" x-data="materialesApp()" :class="{ 'active': $store.ui.isActive('materiales') }">
    <div class="content-header">
      <h1><i class="fas fa-folder-open"></i> Supervisión de Materiales Pedagógicos</h1>
    </div>

    <!-- Estadísticas -->
    <div class="dashboard-grid" style="margin-bottom: 25px;">
      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-clock fa-2x" style="color: #ff9800;"></i>
          <h3>Pendientes</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.pendientes"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-check-circle fa-2x" style="color: #4caf50;"></i>
          <h3>Aprobados</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.aprobados"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-times-circle fa-2x" style="color: #f44336;"></i>
          <h3>Rechazados</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.rechazados"></div>
      </div>

      <div class="indicator-card">
        <div class="indicator-header">
          <i class="fas fa-file-alt fa-2x" style="color: #667eea;"></i>
          <h3>Total</h3>
        </div>
        <div class="indicator-value" x-text="estadisticas.total"></div>
      </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card">
      <h3><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>

      <!-- Buscador -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label><i class="fas fa-search"></i> Buscar</label>
        <input
          type="text"
          x-model="busqueda"
          placeholder="Buscar por título, profesor o asignatura..."
          style="width: 100%;">
      </div>

      <!-- Filtros -->
      <div class="form-row">
        <div class="form-group">
          <label>Estado</label>
          <select x-model="filtros.estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente Revisión</option>
            <option value="aprobado">Aprobado</option>
            <option value="rechazado">Rechazado</option>
            <option value="requiere_correccion">Requiere Corrección</option>
          </select>
        </div>

        <div class="form-group">
          <label>Curso</label>
          <select x-model="filtros.curso">
            <option value="">Todos</option>
            <template x-for="curso in cursos" :key="curso.codigo">
              <option :value="curso.codigo" x-text="curso.nombre"></option>
            </template>
          </select>
        </div>

        <div class="form-group">
          <label>Categoría</label>
          <select x-model="filtros.categoria">
            <option value="">Todas</option>
            <option value="guia">Guía</option>
            <option value="presentacion">Presentación</option>
            <option value="video">Video</option>
            <option value="lectura">Lectura</option>
            <option value="evaluacion">Evaluación</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha Desde</label>
          <input type="date" x-model="filtros.fechaDesde">
        </div>

        <div class="form-group">
          <label>Fecha Hasta</label>
          <input type="date" x-model="filtros.fechaHasta">
        </div>

        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button class="btn btn-secondary" @click="limpiarFiltros()" style="width: 100%;">
            <i class="fas fa-times"></i> Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div :style="(materiales.loading && !materiales.data) ? '' : 'display: none'" class="card" style="margin-top: 20px; text-align: center; padding: 40px;">
      <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
      <p style="margin-top: 15px;">Cargando materiales...</p>
    </div>

    <!-- Materiales Table -->
    <div :style="materiales.data ? '' : 'display: none'" class="card" style="margin-top: 20px;">
      <h3 x-text="`Materiales (${(materialesFiltrados || []).length})`"></h3>

      <p :style="(materialesFiltrados && materialesFiltrados.length === 0) ? '' : 'display: none'" style="text-align: center; color: #666; padding: 30px;">
        No se encontraron materiales
      </p>

      <table :style="(materialesFiltrados && materialesFiltrados.length > 0) ? '' : 'display: none'" class="data-table">
            <thead>
              <tr>
                <th>Título</th>
                <th>Categoría</th>
                <th>Curso</th>
                <th>Asignatura</th>
                <th>Profesor</th>
                <th>Archivo</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="mat in (materialesFiltrados || [])" :key="mat.id">
                <tr>
                  <td><strong x-text="mat.titulo"></strong></td>
                  <td>
                    <span :style="`padding: 4px 8px; border-radius: 8px; font-size: 0.85em; ${getCategoriaStyle(mat.categoria)}`"
                          x-text="getCategoriaNombre(mat.categoria)"></span>
                  </td>
                  <td x-text="mat.curso"></td>
                  <td x-text="mat.asignatura"></td>
                  <td x-text="mat.profesor"></td>
                  <td x-text="mat.nombreArchivo || '-'"></td>
                  <td x-text="formatDate(mat.fechaSubida || mat.fecha)"></td>
                  <td>
                    <span :style="`background: ${$store.utils.getEstadoColor(mat.estado)}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;`"
                          x-text="$store.utils.getEstadoTexto(mat.estado)"></span>
                  </td>
                  <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                      <button class="btn btn-sm btn-primary" @click="verDetalle(mat)" title="Ver Detalle">
                        <i class="fas fa-eye"></i>
                      </button>

                      <template x-if="mat.urlArchivo">
                        <button class="btn btn-sm btn-info" @click="descargarArchivo(mat)" title="Descargar">
                          <i class="fas fa-download"></i>
                        </button>
                      </template>

                      <template x-if="mat.estado === 'pendiente' || mat.estado === 'requiere_correccion'">
                        <button class="btn btn-sm btn-success" @click="aprobar(mat)" title="Aprobar">
                          <i class="fas fa-check"></i>
                        </button>
                      </template>

                      <template x-if="mat.estado === 'pendiente' || mat.estado === 'requiere_correccion'">
                        <button class="btn btn-sm btn-danger" @click="rechazar(mat)" title="Rechazar">
                          <i class="fas fa-times"></i>
                        </button>
                      </template>

                      <template x-if="mat.estado === 'pendiente' || mat.estado === 'requiere_correccion'">
                        <button class="btn btn-sm btn-warning" @click="solicitarCorreccion(mat)" title="Solicitar Corrección">
                          <i class="fas fa-edit"></i>
                        </button>
                      </template>

                      <button class="btn btn-sm btn-danger" @click="eliminar(mat)" title="Eliminar">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- Configuración Section (CU-11, 12) -->
  <div id="configuracion" class="section" :class="{ 'active': $store.ui.isActive('configuracion') }" x-data="configuracionApp()">
    <div class="content-header">
      <h1><i class="fas fa-cogs"></i> Configuración del Sistema</h1>
    </div>

    <!-- Tabs de Configuración -->
    <div class="tabs-container" style="margin-bottom: 20px;">
      <button class="tab-btn" :class="{ 'active': activeTab === 'general' }" @click="cambiarTab('general')">
        <i class="fas fa-info-circle"></i> Información General
      </button>
      <button class="tab-btn" :class="{ 'active': activeTab === 'categorias' }" @click="cambiarTab('categorias')">
        <i class="fas fa-tags"></i> Categorías
      </button>
    </div>

    <!-- Tab: Información General -->
    <div id="config-general" class="tab-content" x-show="activeTab === 'general'">
      <div class="card">
        <h3>Información del Jardín</h3>
        <div class="form-group">
          <label for="nombreJardin">Nombre del Jardín</label>
          <input type="text" id="nombreJardin" placeholder="Nombre del establecimiento">
        </div>
        <div class="form-group">
          <label for="direccionJardin">Dirección</label>
          <input type="text" id="direccionJardin" placeholder="Dirección del jardín">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="telefonoJardin">Teléfono</label>
            <input type="tel" id="telefonoJardin" placeholder="+56 9 XXXX XXXX">
          </div>
          <div class="form-group">
            <label for="emailJardin">Email</label>
            <input type="email" id="emailJardin" placeholder="contacto@jardin.cl">
          </div>
        </div>
        <div class="form-group">
          <label for="anoEscolar">Año Escolar</label>
          <input type="number" id="anoEscolar" min="2020" max="2050" value="2025">
        </div>
      </div>

      <div class="card">
        <h3>Cursos</h3>

        <!-- Loading -->
        <div x-show="loading" style="text-align: center; padding: 20px; color: #a855f7;">
          <i class="fas fa-spinner fa-spin"></i> Cargando cursos...
        </div>

        <!-- Lista de cursos -->
        <div x-show="!loading">
          <template x-if="cursos.length === 0">
            <p style="color: #666; text-align: center; padding: 20px;">No hay cursos configurados</p>
          </template>

          <div x-show="cursos.length > 0" style="display: flex; flex-direction: column; gap: 10px;">
            <template x-for="(curso, index) in cursos" :key="curso.codigo">
              <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 16px;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                transition: all 0.2s;
              "
              @mouseenter="$el.style.background = '#f8fafc'"
              @mouseleave="$el.style.background = 'white'">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="
                    background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
                    color: white;
                    width: 40px;
                    height: 40px;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                  " x-text="index + 1"></div>
                  <div>
                    <div style="font-weight: 600; color: #1e293b;" x-text="curso.nombre"></div>
                    <div style="font-size: 0.85rem; color: #64748b;" x-text="'Código: ' + curso.codigo"></div>
                  </div>
                </div>
                <span style="
                  background: #10b981;
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                  font-size: 0.8rem;
                  font-weight: 600;
                ">Activo</span>
              </div>
            </template>
          </div>
        </div>

        <button class="btn btn-sm btn-primary" @click="agregarCurso()" style="margin-top: 16px;">
          <i class="fas fa-plus"></i> Agregar Curso
        </button>
      </div>

      <div class="card">
        <h3>Asignaturas / Núcleos de Aprendizaje</h3>

        <!-- Loading -->
        <div x-show="loading" style="text-align: center; padding: 20px; color: #a855f7;">
          <i class="fas fa-spinner fa-spin"></i> Cargando asignaturas...
        </div>

        <!-- Lista de asignaturas -->
        <div x-show="!loading">
          <template x-if="asignaturas.length === 0">
            <p style="color: #666; text-align: center; padding: 20px;">No hay asignaturas configuradas</p>
          </template>

          <div x-show="asignaturas.length > 0" style="display: flex; flex-wrap: wrap; gap: 10px;">
            <template x-for="asignatura in asignaturas" :key="asignatura">
              <span style="
                background: #f1f5f9;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9rem;
                color: #334155;
                display: inline-flex;
                align-items: center;
                gap: 8px;
              ">
                <span x-text="asignatura"></span>
                <button @click="eliminarAsignatura(asignatura)" style="
                  background: none;
                  border: none;
                  color: #ef4444;
                  cursor: pointer;
                  padding: 0;
                  display: flex;
                  align-items: center;
                " title="Eliminar">
                  <i class="fas fa-times"></i>
                </button>
              </span>
            </template>
          </div>
        </div>

        <button class="btn btn-sm btn-primary" @click="agregarAsignatura()" style="margin-top: 16px;">
          <i class="fas fa-plus"></i> Agregar Asignatura
        </button>
      </div>

      <button class="btn btn-success" @click="guardarConfiguracion()">
        <i class="fas fa-save"></i> Guardar Configuración
      </button>
    </div>

    <!-- Tab: Categorías -->
    <div id="config-categorias" class="tab-content" x-show="activeTab === 'categorias'">
      <div class="content-header">
        <h2><i class="fas fa-tags"></i> Gestión de Categorías</h2>
        <button class="btn btn-primary" @click="agregarCategoria()"><i class="fas fa-plus"></i> Nueva Categoría</button>
      </div>

      <!-- Loading -->
      <div x-show="loading" style="text-align: center; padding: 50px; color: #a855f7;">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top: 16px;">Cargando categorías...</p>
      </div>

      <!-- Lista de categorías -->
      <div x-show="!loading">
        <template x-if="categorias.length === 0">
          <div class="card" style="text-align: center; padding: 60px;">
            <i class="fas fa-tags fa-3x" style="color: #cbd5e1; margin-bottom: 16px;"></i>
            <p style="color: #64748b; font-size: 1.1rem;">No hay categorías creadas</p>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 8px;">Crea tu primera categoría para organizar los materiales</p>
          </div>
        </template>

        <div x-show="categorias.length > 0" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
          <template x-for="categoria in categorias" :key="categoria.id">
            <div class="card" style="
              border-left: 4px solid;
              transition: all 0.2s;
            "
            :style="`border-left-color: ${categoria.color || '#a855f7'}`"
            @mouseenter="$el.style.transform = 'translateY(-4px)'; $el.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)'"
            @mouseleave="$el.style.transform = 'translateY(0)'; $el.style.boxShadow = ''">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <h3 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 10px;">
                  <div :style="`
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: ${categoria.color || '#a855f7'};
                  `"></div>
                  <span x-text="categoria.nombre"></span>
                </h3>
                <button @click="eliminarCategoria(categoria)" style="
                  background: #fee2e2;
                  color: #ef4444;
                  border: none;
                  padding: 6px 10px;
                  border-radius: 6px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                @mouseenter="$el.style.background = '#fecaca'"
                @mouseleave="$el.style.background = '#fee2e2'"
                title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <p style="color: #64748b; font-size: 0.9rem; margin: 0;" x-text="categoria.descripcion || 'Sin descripción'"></p>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>


  <!-- Gestión de Usuarios Section (Consolidado: Usuarios, Cursos, Profesores, Aceptados) -->
  <!-- Usuarios Section -->
  <div id="usuarios" class="section" x-data="usuariosApp()" :class="{ 'active': $store.ui.isActive('usuarios') }">
    <div class="content-header">
      <h1><i class="fas fa-users"></i> Gestión de Usuarios</h1>
      <button class="btn btn-primary" @click="crearUsuario()">
        <i class="fas fa-plus"></i> Nuevo Usuario
      </button>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-bottom: 20px;">
      <h3>Filtros</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Buscar</label>
          <input type="text" x-model="filtros.busqueda" placeholder="Buscar por nombre, RUT o correo...">
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select x-model="filtros.rol">
            <option value="">Todos los roles</option>
            <option value="profesor">Profesores</option>
            <option value="fono">Fonoaudiólogos</option>
            <option value="alumno">Alumnos/Apoderados</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estado</label>
          <select x-model="filtros.estado">
            <option value="">Todos los estados</option>
            <option value="activo">Activos</option>
            <option value="inactivo">Inactivos</option>
          </select>
        </div>
      </div>
    </div>

      <!-- Tabla de Usuarios -->
      <div class="card" style="overflow: hidden;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0;">
          <h3 style="margin: 0; color: #2c3e50; font-size: 1.3rem;">Lista de Usuarios</h3>
        </div>

        <!-- Loading state -->
        <div :style="(usuarios.loading && !usuarios.data) ? '' : 'display: none'" style="text-align: center; padding: 50px;">
          <i class="fas fa-spinner fa-spin fa-3x" style="color: #a855f7;"></i>
          <p style="margin-top: 16px; color: #64748b; font-size: 1rem;">Cargando usuarios...</p>
        </div>

        <!-- Tabla con datos -->
        <div :style="(usuarios.data && usuarios.data.length > 0) ? '' : 'display: none'" style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">RUT</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Nombre</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Apellido</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Email</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Teléfono</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Rol</th>
                <th style="padding: 16px; text-align: left; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Estado</th>
                <th style="padding: 16px; text-align: center; color: white; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="u in usuariosFiltrados" :key="u.rut">
                <tr :style="`background: ${u.activo === false ? '#f8fafc' : 'white'}; border-bottom: 1px solid #e2e8f0; transition: all 0.2s;`"
                    @mouseenter="$el.style.background = '#f1f5f9'"
                    @mouseleave="$el.style.background = u.activo === false ? '#f8fafc' : 'white'">
                  <td style="padding: 14px 16px; color: #334155; font-weight: 500; font-size: 0.9rem;" x-text="u.rut"></td>
                  <td style="padding: 14px 16px; color: #1e293b; font-weight: 600; font-size: 0.95rem;" x-text="u.nombre"></td>
                  <td style="padding: 14px 16px; color: #334155; font-size: 0.9rem;" x-text="u.apellido || '-'"></td>
                  <td style="padding: 14px 16px; color: #64748b; font-size: 0.9rem;" x-text="u.correo"></td>
                  <td style="padding: 14px 16px; color: #64748b; font-size: 0.9rem;" x-text="u.telefono || '-'"></td>
                  <td style="padding: 14px 16px;">
                    <span
                      :style="`
                        background: ${getRolColor(u.rol)};
                        color: white;
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        display: inline-block;
                        text-transform: capitalize;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      `"
                      x-text="getRolLabel(u.rol)">
                    </span>
                  </td>
                  <td style="padding: 14px 16px;">
                    <span
                      :style="`
                        background: ${u.activo !== false ? '#10b981' : '#ef4444'};
                        color: white;
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        display: inline-block;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      `"
                      x-text="u.activo !== false ? 'Activo' : 'Inactivo'">
                    </span>
                  </td>
                  <td style="padding: 14px 16px; text-align: center;">
                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                      <button
                        @click="cambiarRol(u)"
                        title="Cambiar Rol"
                        :disabled="u.activo === false"
                        style="
                          background: #a855f7;
                          color: white;
                          border: none;
                          padding: 8px 10px;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          font-size: 0.9rem;
                          display: inline-flex;
                          align-items: center;
                          justify-content: center;
                        "
                        @mouseenter="$el.style.background = '#9333ea'; $el.style.transform = 'translateY(-2px)'"
                        @mouseleave="$el.style.background = '#a855f7'; $el.style.transform = 'translateY(0)'">
                        <i class="fas fa-user-tag"></i>
                      </button>
                      <button
                        @click="editarUsuario(u)"
                        title="Editar"
                        style="
                          background: #3b82f6;
                          color: white;
                          border: none;
                          padding: 8px 10px;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          font-size: 0.9rem;
                          display: inline-flex;
                          align-items: center;
                          justify-content: center;
                        "
                        @mouseenter="$el.style.background = '#2563eb'; $el.style.transform = 'translateY(-2px)'"
                        @mouseleave="$el.style.background = '#3b82f6'; $el.style.transform = 'translateY(0)'">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        @click="toggleEstadoUsuario(u)"
                        :title="u.activo !== false ? 'Desactivar' : 'Activar'"
                        :style="`
                          background: ${u.activo !== false ? '#ef4444' : '#10b981'};
                          color: white;
                          border: none;
                          padding: 8px 10px;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          font-size: 0.9rem;
                          display: inline-flex;
                          align-items: center;
                          justify-content: center;
                        `"
                        @mouseenter="$el.style.background = u.activo !== false ? '#dc2626' : '#059669'; $el.style.transform = 'translateY(-2px)'"
                        @mouseleave="$el.style.background = u.activo !== false ? '#ef4444' : '#10b981'; $el.style.transform = 'translateY(0)'">
                        <i :class="u.activo !== false ? 'fas fa-ban' : 'fas fa-check'"></i>
                      </button>
                      <button
                        x-show="tieneMatriculaPendiente(u)"
                        @click="aprobarMatricula(u)"
                        title="Aprobar Matrícula"
                        style="
                          background: #10b981;
                          color: white;
                          border: none;
                          padding: 8px 10px;
                          border-radius: 8px;
                          cursor: pointer;
                          transition: all 0.2s;
                          font-size: 0.9rem;
                          display: inline-flex;
                          align-items: center;
                          justify-content: center;
                        "
                        @mouseenter="$el.style.background = '#059669'; $el.style.transform = 'translateY(-2px)'"
                        @mouseleave="$el.style.background = '#10b981'; $el.style.transform = 'translateY(0)'">
                        <i class="fas fa-check-circle"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>


  </div>
</main>

<!-- Modal eventos -->
<div id="modal" class="modal" onclick="cerrarModalSiClickEnBackdrop(event, 'modal')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Nuevo Evento/Evaluación</h2>
    <form id="eventForm">
      <input type="hidden" id="eventId">
      <div class="form-group">
        <label for="tituloEvento">Título</label>
        <input id="tituloEvento" type="text" name="titulo" required>
      </div>
      <div class="form-group">
        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" name="descripcion"></textarea>
      </div>
      <div class="form-group">
        <label for="fecha">Fecha</label>
        <input id="fecha" type="date" name="fecha" required>
      </div>
      <div class="form-group">
        <label for="hora">Hora</label>
        <input id="hora" type="time" name="hora">
      </div>
      <div class="form-group">
        <label for="tipo">Tipo</label>
        <select id="tipo" name="tipo">
          <option value="evento">Evento</option>
          <option value="evaluacion">Evaluación</option>
        </select>
      </div>
      <div class="form-group">
        <label for="curso">Curso</label>
        <select id="curso" name="curso">
          <option value="todos">Todos</option>
          <option value="medio-mayor">Medio Mayor</option>
          <option value="prekinder-a">Prekínder A</option>
          <option value="prekinder-b">Prekínder B</option>
          <option value="kinder">Kínder</option>
          <option value="extension">Extensión Horaria</option>
        </select>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="deleteEvent()">Eliminar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Categorías -->
<div id="modalCategoria" class="modal" onclick="cerrarModalSiClickEnBackdrop(event, 'modalCategoria')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="ocultarFormularioCategoria()">&times;</span>
    <h2 id="tituloFormCategoria">Crear Nueva Categoría</h2>
    <form onsubmit="event.preventDefault(); guardarCategoria();">
      <div class="form-group">
        <label for="nombreCategoria">Nombre *</label>
        <input type="text" id="nombreCategoria" placeholder="Ej: Matemáticas, Lenguaje..." required>
      </div>
      <div class="form-group">
        <label for="descripcionCategoria">Descripción</label>
        <textarea id="descripcionCategoria" rows="2" placeholder="Descripción de la categoría (opcional)"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="colorCategoria">Color</label>
          <input type="color" id="colorCategoria" value="#4A90E2">
        </div>
        <div class="form-group">
          <label for="iconoCategoria">Icono (FontAwesome)</label>
          <input type="text" id="iconoCategoria" placeholder="folder, book, file..." value="folder">
        </div>
      </div>
      <input type="hidden" id="categoriaIdEditar">
      <div style="text-align: center; margin-top: 20px;">
        <button type="submit" class="btn btn-success">Guardar Categoría</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormularioCategoria()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- ✅ Alpine.js Apps están en módulos separados (cargados en <head> con defer) -->

</body>
</html>
